CREATE OR REPLACE VIEW gold_weekly_fitness_summary AS
WITH training_summary AS (
    SELECT
        DATE_TRUNC('week', w.workout_date)::date AS week_start,
        COUNT(DISTINCT w.workout_id)             AS training_sessions,
        COUNT(s.set_id)                          AS total_sets,
        COUNT(*) FILTER (WHERE s.set_type = 'failure') AS failure_sets,
        ROUND(AVG(s.reps), 2)                    AS avg_reps_per_set
    FROM workouts w
    JOIN workout_exercises we
        ON w.workout_id = we.workout_id
    JOIN sets s
        ON we.workout_exercise_id = s.workout_exercise_id
    WHERE s.set_type <> 'warmup'
    GROUP BY week_start
)
SELECT
    d.week_start,

    -- Diet
    d.avg_calories_kcal,
    d.avg_carbs_g,
    d.avg_protein_g,
    d.avg_fat_g,
    d.avg_bodyweight_kg,
    d.cardio_weekly_min,
    d.logged_days,

    -- Training
    t.training_sessions,
    t.total_sets,
    t.failure_sets,
    t.avg_reps_per_set,

    -- Cycle
    c.cycle_name,
    c.cycle_type
FROM gold_weekly_diet_summary d
LEFT JOIN training_summary t
    ON d.week_start = t.week_start
LEFT JOIN cycles c
    ON d.cycle_id = c.cycle_id;


CREATE OR REPLACE VIEW gold_weekly_training_detail AS
SELECT
    DATE_TRUNC('week', w.workout_date)::date AS week_start,

    e.exercise_name,
    mg.muscle_group_name,

    COUNT(s.set_id)                          AS total_sets,
    ROUND(AVG(s.weight_kg), 2)               AS avg_weight_kg,
    ROUND(AVG(s.reps), 2)                    AS avg_reps,
    MAX(s.weight_kg)                         AS max_weight_kg,

    COUNT(*) FILTER (WHERE s.set_type = 'failure') AS failure_sets
FROM workouts w
JOIN workout_exercises we
    ON w.workout_id = we.workout_id
JOIN exercises e
    ON we.exercise_id = e.exercise_id
JOIN exercise_muscle_map emm
    ON e.exercise_id = emm.exercise_id
JOIN muscle_groups mg
    ON emm.muscle_group_id = mg.muscle_group_id
JOIN sets s
    ON we.workout_exercise_id = s.workout_exercise_id
WHERE s.set_type <> 'warmup'
GROUP BY
    week_start,
    e.exercise_name,
    mg.muscle_group_name;


CREATE OR REPLACE VIEW gold_weekly_exercise_performance AS
SELECT
    DATE_TRUNC('week', w.workout_date)::date AS week_start,

    e.exercise_id,
    e.exercise_name,
    mg.muscle_group_name,

    COUNT(s.set_id) AS total_sets,

    COUNT(*) FILTER (
        WHERE s.set_type = 'failure'
    ) AS failure_sets,

    ROUND(AVG(s.reps), 2) AS avg_reps,

    ROUND(AVG(s.weight_kg), 2) AS avg_weight_kg,
    MAX(s.weight_kg)           AS max_weight_kg,

    SUM(s.reps) AS total_reps,

    COUNT(DISTINCT w.workout_id) AS sessions_count

FROM workouts w
JOIN workout_exercises we
    ON w.workout_id = we.workout_id
JOIN sets s
    ON we.workout_exercise_id = s.workout_exercise_id
JOIN exercises e
    ON we.exercise_id = e.exercise_id
JOIN exercise_muscle_map emm
    ON e.exercise_id = emm.exercise_id
JOIN muscle_groups mg
    ON emm.muscle_group_id = mg.muscle_group_id

WHERE s.set_type <> 'warmup'

GROUP BY
    week_start,
    e.exercise_id,
    e.exercise_name,
    mg.muscle_group_name;


CREATE OR REPLACE VIEW gold_weekly_exercise_progression AS
SELECT
    week_start,
    exercise_id,
    exercise_name,
    muscle_group_name,

    -- Current week metrics
    total_sets,
    total_reps,
    avg_reps,
    avg_weight_kg,
    max_weight_kg,
    failure_sets,
    sessions_count,

    -- Previous week metrics
    LAG(total_sets)      OVER w AS prev_total_sets,
    LAG(total_reps)      OVER w AS prev_total_reps,
    LAG(avg_reps)        OVER w AS prev_avg_reps,
    LAG(avg_weight_kg)   OVER w AS prev_avg_weight_kg,
    LAG(max_weight_kg)   OVER w AS prev_max_weight_kg,
    LAG(failure_sets)    OVER w AS prev_failure_sets,

    -- Deltas
    total_sets    - LAG(total_sets)    OVER w AS delta_total_sets,
    total_reps    - LAG(total_reps)    OVER w AS delta_total_reps,
    avg_reps      - LAG(avg_reps)      OVER w AS delta_avg_reps,
    avg_weight_kg - LAG(avg_weight_kg) OVER w AS delta_avg_weight_kg,
    max_weight_kg - LAG(max_weight_kg) OVER w AS delta_max_weight_kg,
    failure_sets  - LAG(failure_sets)  OVER w AS delta_failure_sets

FROM gold_weekly_exercise_performance
WINDOW w AS (
    PARTITION BY exercise_id
    ORDER BY week_start
);

CREATE OR REPLACE VIEW gold_llm_weekly_exercise_context AS
SELECT
    p.week_start,

    -- Exercise identity
    p.exercise_id,
    p.exercise_name,
    p.muscle_group_name,

    -- Training (current week)
    p.total_sets,
    p.total_reps,
    p.avg_reps,
    p.avg_weight_kg,
    p.max_weight_kg,
    p.failure_sets,
    p.sessions_count,

    -- Training deltas (vs previous week)
    p.delta_total_sets,
    p.delta_total_reps,
    p.delta_avg_reps,
    p.delta_avg_weight_kg,
    p.delta_max_weight_kg,
    p.delta_failure_sets,

    -- Diet context (weekly)
    d.avg_calories_kcal,
    d.avg_carbs_g,
    d.avg_protein_g,
    d.avg_fat_g,
    d.cardio_weekly_min,
    d.avg_bodyweight_kg,
    d.logged_days,

    -- Cycle context
    c.cycle_id,
    c.cycle_name,
    c.cycle_type

FROM gold_weekly_exercise_progression p
LEFT JOIN gold_weekly_diet_summary d
    ON p.week_start = d.week_start
LEFT JOIN cycles c
    ON d.cycle_id = c.cycle_id;

